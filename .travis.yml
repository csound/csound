language: cpp
env:
  global:
    - secure: "pOICMBtfwljj450Vht1D2/XvtUm07edkbiUI0+PCnfuwiwBFJyqY919whZu+CrplQvkVS+RzvxT3wpgkVccflo0uvNJ7NwfKksRqrUKwTp59nGIwjUsnDjI3YkxOQyxIdIPsSm3bUxXVy/Jge0v6vzvbbPXKxyAxKsupnUBYOwM="
    - OMP_NUM_THREADS=4
    - VERBOSE=1
before_script:
  - mkdir -p "$TRAVIS_BUILD_DIR"/build
  - if [[ "$TRAVIS_OS_NAME" == "osx" ]]; then (git clone git://github.com/erikd/libsndfile.git && cd libsndfile && mkdir -p build && cd build && cmake -DCMAKE_BUILD_TYPE=Release -DCMAKE_INSTALL_PREFIX=$HOME .. && make && make install); fi
script:
  - "[ ${COVERITY_SCAN_BRANCH} == 1 ] || (cd $TRAVIS_BUILD_DIR/build && cmake .. -DCMAKE_INCLUDE_PATH=$HOME/include -DCMAKE_LIBRARY_PATH=$HOME/lib -DCMAKE_BUILD_TYPE=Release -DBUILD_STATIC_LIBRARY=ON -DBUILD_TESTS=ON -DCMAKE_INSTALL_PREFIX=$HOME make && make $COMMAND)"

jobs:
  include:
    - stage: test
      name: C Tests
      env: COMMAND=test
    - env: COMMAND=regression
      name: Regression Tests
    - env: COMMAND=csdtests
      name: CSD tests
    - env: COMMAND=soak
      dist: bionic
      name: Soak tests
      compiler: gcc
    - stage: release
      dist: trusty
      compiler: gcc
      os: linux
      name: Linux GCC
      env: COMMAND=test
    - os: linux
      name: Linux clang
      dist: xenial
      compiler: clang
      env: COMMAND=test
    - os: osx
      name: OSX clang
      compiler: clang
      env: COMMAND=test

addons:
  coverity_scan:
    project:
      name: "csound/csound"
      description: "A user-programmable and user-extensible sound processing language and software synthesizer"
    notification_email: CSOUND-DEV@listserv.heanet.ie
    build_command_prepend: "mkdir -p $TRAVIS_BUILD_DIR/build && cd $TRAVIS_BUILD_DIR/build && cmake .."
    build_command: "make -C $TRAVIS_BUILD_DIR/build"
    branch_pattern: coverity_scan
  apt:
    sources:
      - deadsnakes
    packages:
      - cmake
      - libssl-dev
      - ca-certificates
      - libsndfile1-dev
      - libasound2-dev
      - libjack-dev
      - portaudio19-dev
      - libportmidi-dev
      - libpulse-dev
      - swig
      - liblua5.1-0-dev
      - python-dev
      - python3.7-venv
      - puredata-dev
      - default-jdk
      - libfltk1.1-dev
      - libfluidsynth-dev
      - liblo-dev
      - fluid
      - ladspa-sdk
      - libpng-dev
      - dssi-dev
      - libstk0-dev
      - libgmm++-dev
      - bison
      - flex
      - libportsmf-dev
      - libeigen3-dev
      - libcunit1-dev
      - python-tk
notifications:
  email:
    recipients:
      - CSOUND-DEV@listserv.heanet.ie
